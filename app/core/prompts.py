"""
æç¤ºè¯æ¨¡æ¿æ¨¡å—

åŸºäºSOTAç ”ç©¶çš„ä¸“ä¸šæç¤ºè¯æ¨¡æ¿ï¼Œæ”¯æŒå¤šé˜¶æ®µå·¥ä½œæµã€‚
åŒ…å«é—®é¢˜æ‰©å†™ã€ä¸“å®¶åˆ†æã€ä»»åŠ¡è§„åˆ’ã€ç»¼åˆåˆ†æç­‰æç¤ºè¯æ¨¡æ¿ã€‚
"""

from typing import Dict, Any, Optional


def build_question_expansion_prompt(current_question: str, history_context: str, 
                                  recent_questions: list) -> str:
    """
    æ„å»ºé—®é¢˜æ‰©å†™æç¤ºè¯
    æ ¹æ®å†å²ä¼šè¯å’Œå†å²é—®é¢˜å¯¹å½“å‰é—®é¢˜è¿›è¡Œä¸Šä¸‹æ–‡æ‰©å†™
    
    Args:
        current_question: å½“å‰ç”¨æˆ·é—®é¢˜
        history_context: å†å²ä¼šè¯ä¸Šä¸‹æ–‡
        recent_questions: æœ€è¿‘çš„å†å²é—®é¢˜åˆ—è¡¨
        
    Returns:
        é—®é¢˜æ‰©å†™æç¤ºè¯
    """
    # æ„å»ºå†å²é—®é¢˜åˆ—è¡¨
    history_questions_text = ""
    if recent_questions:
        history_questions_text = "\n".join([f"- {q}" for q in recent_questions[-5:]])  # æœ€è¿‘5ä¸ªé—®é¢˜
    else:
        history_questions_text = "æ— å†å²é—®é¢˜"
    
    return f"""
ä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ç†è§£ä¸“å®¶ï¼Œæ‚¨éœ€è¦åŸºäºå†å²ä¼šè¯å’Œé—®é¢˜ï¼Œå¯¹å½“å‰é—®é¢˜è¿›è¡Œæ™ºèƒ½æ‰©å†™ï¼Œä½¿å…¶æ›´åŠ å®Œæ•´å’Œå‡†ç¡®ã€‚

**å½“å‰åˆ†æä»»åŠ¡:**
å½“å‰é—®é¢˜: {current_question}

**å†å²ä¸Šä¸‹æ–‡ä¿¡æ¯:**
å†å²ä¼šè¯: {history_context}

æœ€è¿‘çš„å†å²é—®é¢˜:
{history_questions_text}

**æ‰©å†™è¦æ±‚:**

1. **ä¸Šä¸‹æ–‡ç†è§£**
   - åˆ†æå½“å‰é—®é¢˜ä¸å†å²ä¼šè¯çš„å…³è”æ€§
   - è¯†åˆ«é—®é¢˜ä¸­å¯èƒ½çš„çœç•¥æˆ–ç®€åŒ–è¡¨è¾¾
   - ç†è§£ç”¨æˆ·åœ¨æ•´ä¸ªä¼šè¯æµç¨‹ä¸­çš„çœŸå®æ„å›¾

2. **é—®é¢˜è¡¥å…¨ä¸æ‰©å†™**
   - åŸºäºå†å²ä¸Šä¸‹æ–‡ï¼Œè¡¥å…¨å½“å‰é—®é¢˜ä¸­çš„çœç•¥ä¿¡æ¯
   - æ˜ç¡®é—®é¢˜ä¸­çš„æŒ‡ä»£å…³ç³»ï¼ˆå¦‚"è¿™ä¸ª"ã€"å®ƒ"ã€"ä¸Šè¿°"ç­‰ï¼‰
   - æ·»åŠ å¿…è¦çš„èƒŒæ™¯ä¿¡æ¯å’Œé™å®šæ¡ä»¶
   - ä¿æŒé—®é¢˜çš„æ ¸å¿ƒæ„å›¾ä¸å˜

3. **è´¨é‡æ§åˆ¶**
   - å¦‚æœå½“å‰é—®é¢˜å·²ç»å¾ˆå®Œæ•´ï¼Œæ— éœ€å¤§å¹…ä¿®æ”¹
   - æ‰©å†™åçš„é—®é¢˜åº”è¯¥æ›´åŠ æ¸…æ™°ã€å…·ä½“å’Œå¯æ‰§è¡Œ
   - é¿å…è¿‡åº¦æ‰©å†™å¯¼è‡´é—®é¢˜åç¦»åŸæ„
   - ä¿æŒè‡ªç„¶çš„è¡¨è¾¾æ–¹å¼

**æ‰©å†™ç­–ç•¥:**
- è‹¥å½“å‰é—®é¢˜ä¸å†å²ä¼šè¯é«˜åº¦ç›¸å…³ï¼šè¿›è¡Œä¸Šä¸‹æ–‡è¡¥å…¨
- è‹¥å½“å‰é—®é¢˜æ˜¯ç‹¬ç«‹çš„æ–°é—®é¢˜ï¼šè¿›è¡Œé€‚åº¦ä¼˜åŒ–å’Œæ˜ç¡®åŒ–
- è‹¥å½“å‰é—®é¢˜å«æœ‰æŒ‡ä»£è¯ï¼šåŸºäºå†å²ä¿¡æ¯è¿›è¡Œå…·ä½“åŒ–
- è‹¥å½“å‰é—®é¢˜è¿‡äºç®€å•ï¼šé€‚å½“å¢åŠ ç»†èŠ‚å’ŒèƒŒæ™¯

ä»¥JSONæ ¼å¼è¿”å›æ‰©å†™ç»“æœï¼š
{{
    "expanded_question": "æ‰©å†™åçš„å®Œæ•´é—®é¢˜ï¼Œä¿æŒåŸæ„çš„åŒæ—¶æ›´åŠ æ¸…æ™°å®Œæ•´",
    "expansion_reasoning": "æ‰©å†™çš„ç†ç”±å’Œä¾æ®ï¼Œè¯´æ˜è¿›è¡Œäº†å“ªäº›è¡¥å…¨å’Œä¼˜åŒ–",
    "context_relevance": "high|medium|low - å½“å‰é—®é¢˜ä¸å†å²ä¸Šä¸‹æ–‡çš„å…³è”åº¦",
    "original_intent": "å¯¹ç”¨æˆ·åŸå§‹æ„å›¾çš„ç†è§£æ€»ç»“"
}}

é‡è¦ï¼šè¯·åªè¿”å›JSONå¯¹è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡æœ¬ã€‚
"""


def build_expert_analysis_prompt(user_question: str, history_context: str) -> str:
    """
    æ„å»ºä¸“å®¶çº§åˆ«çš„é—®é¢˜åˆ†ææç¤ºè¯
    åŸºäºSOTAç ”ç©¶ä¸­çš„structured reasoningå’Œexpert analysisæ¨¡å¼
    
    Args:
        user_question: ç”¨æˆ·é—®é¢˜
        history_context: å¯¹è¯å†å²ä¸Šä¸‹æ–‡
        
    Returns:
        ä¸“å®¶åˆ†ææç¤ºè¯
    """
    return f"""
ä½œä¸ºä¸€åè·¨é¢†åŸŸä¸“å®¶åˆ†æå¸ˆï¼Œæ‚¨éœ€è¦å¯¹ç”¨æˆ·é—®é¢˜è¿›è¡Œæ·±åº¦ã€ç³»ç»Ÿæ€§çš„ä¸“ä¸šåˆ†æã€‚

**å½“å‰åˆ†æä»»åŠ¡:**
ç”¨æˆ·é—®é¢˜: {user_question}
å¯¹è¯å†å²: {history_context}

**åˆ†æè¦æ±‚:**
æ‚¨å¿…é¡»ä»¥é¢†åŸŸä¸“å®¶çš„èº«ä»½è¿›è¡Œå…¨é¢åˆ†æï¼Œä¸¥æ ¼åŸºäºæä¾›çš„ä¿¡æ¯ï¼Œé¿å…ä»»ä½•ä¸å½“çš„é¢†åŸŸåè§æˆ–æ‰©å±•ã€‚

**åˆ†ææ­¥éª¤ - è¯·é€æ­¥æ‰§è¡Œå¹¶å±•ç¤ºæ‚¨çš„åˆ†æè¿‡ç¨‹:**

1. **é—®é¢˜ç†è§£ä¸è§£æ**
   - è¯†åˆ«é—®é¢˜çš„æ ¸å¿ƒæ¦‚å¿µå’Œå…³é”®è¦ç´ 
   - ç†è§£é—®é¢˜çš„å…·ä½“å†…å®¹å’ŒèŒƒå›´
   - åˆ†æé—®é¢˜å¯èƒ½æ¶‰åŠçš„ä¸»è¦æ–¹é¢

2. **ä¿¡æ¯éœ€æ±‚è¯†åˆ«**
   - ç¡®å®šå›ç­”é—®é¢˜æ‰€éœ€çš„æ ¸å¿ƒä¿¡æ¯
   - è¯†åˆ«ç›¸å…³çš„çŸ¥è¯†é¢†åŸŸå’Œä¸“ä¸šå†…å®¹
   - ç†è§£ç”¨æˆ·çš„è¯¢é—®æ„å›¾å’ŒæœŸæœ›

3. **åˆ†æç­–ç•¥åˆ¶å®š**
   - ç¡®å®šé€‚åˆçš„åˆ†ææ–¹æ³•å’Œæ€è·¯
   - è¯†åˆ«é—®é¢˜çš„å¤æ‚ç¨‹åº¦å’Œå±‚æ¬¡
   - è§„åˆ’åˆç†çš„ä¿¡æ¯ç»„ç»‡æ–¹å¼

è¯·åŸºäºä»¥ä¸Šæ­¥éª¤è¿›è¡Œè¯¦ç»†åˆ†æï¼Œæ¯ä¸ªæ­¥éª¤éƒ½è¦å±•ç¤ºæ‚¨çš„å…·ä½“åˆ†æè¿‡ç¨‹å’Œç»“è®ºã€‚

ä»¥JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼š
{{
    "expert_analysis": "æ‚¨çš„è¯¦ç»†ä¸“ä¸šåˆ†æå†…å®¹ï¼Œè‡³å°‘300å­—ï¼Œä½“ç°ä¸“å®¶çº§åˆ«çš„æ·±åº¦æ€è€ƒ"
}}

é‡è¦ï¼šè¯·åªè¿”å›JSONå¯¹è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡æœ¬ã€‚
"""


def build_universal_task_planning_prompt(optimized_question: str, analysis_result: str, history_context: str = "") -> str:
    """
    æ„å»ºé€šç”¨ä»»åŠ¡è§„åˆ’æç¤ºè¯
    ä¸¥æ ¼åŸºäºç”¨æˆ·é—®é¢˜å’Œå†å²å¯¹è¯ç”Ÿæˆæ£€ç´¢æŸ¥è¯¢
    
    Args:
        optimized_question: ä¼˜åŒ–åçš„é—®é¢˜
        analysis_result: ä¸“å®¶åˆ†æç»“æœ
        history_context: å†å²å¯¹è¯ä¸Šä¸‹æ–‡
        
    Returns:
        ä»»åŠ¡è§„åˆ’æç¤ºè¯
    """
    return f"""
ä½œä¸ºä¿¡æ¯æ£€ç´¢ä¸“å®¶ï¼Œæ‚¨éœ€è¦ä¸¥æ ¼åŸºäºç”¨æˆ·é—®é¢˜è®¾è®¡ç²¾å‡†çš„æ£€ç´¢æŸ¥è¯¢ã€‚

**æ ¸å¿ƒä»»åŠ¡:**
ç”¨æˆ·é—®é¢˜: {optimized_question}
ä¸“å®¶åˆ†æ: {analysis_result}
å†å²å¯¹è¯: {history_context}

**æ£€ç´¢èµ„æº:**
- **åœ¨çº¿æœç´¢**: æœ€æ–°ä¿¡æ¯ã€å®æ—¶æ•°æ®ã€å½“å‰åŠ¨æ€
- **çŸ¥è¯†åº“æ£€ç´¢**: ä¸“ä¸šçŸ¥è¯†ã€æŠ€æœ¯æ–‡æ¡£ã€æƒå¨èµ„æ–™
- **çŸ¥è¯†å›¾è°±æ£€ç´¢**: æ¦‚å¿µå…³è”ã€ç³»ç»Ÿå…³ç³»ã€æ·±å±‚è”ç³»

**æŸ¥è¯¢ç”Ÿæˆè¦æ±‚:**
1. **ä¸¥æ ¼åŸºäºç”¨æˆ·é—®é¢˜**: æ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»å›´ç»•ç”¨æˆ·é—®é¢˜çš„æ ¸å¿ƒéœ€æ±‚
2. **åˆ©ç”¨å†å²å¯¹è¯**: è€ƒè™‘å†å²å¯¹è¯çš„ä¸Šä¸‹æ–‡å’Œå…³è”
3. **é™ˆè¿°å¥å½¢å¼**: ä½¿ç”¨é™ˆè¿°å¥æè¿°éœ€è¦æ£€ç´¢çš„ä¿¡æ¯å†…å®¹
4. **å…³é”®è¯ä¸°å¯Œ**: åŒ…å«é—®é¢˜ä¸­çš„æ ¸å¿ƒæ¦‚å¿µå’Œç›¸å…³æœ¯è¯­
5. **é¿å…åç¦»**: ä¸è¦æ‰©å±•åˆ°ç”¨æˆ·é—®é¢˜ä¹‹å¤–çš„æ— å…³å†…å®¹

**å…·ä½“è¦æ±‚:**
- **åœ¨çº¿æœç´¢æŸ¥è¯¢**: é’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„æœ€æ–°ä¿¡æ¯ã€å®æ—¶æ•°æ®å’Œå½“å‰çŠ¶å†µï¼Œ80-120å­—
- **çŸ¥è¯†åº“æŸ¥è¯¢**: é’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„ä¸“ä¸šçŸ¥è¯†ã€ç†è®ºåŸºç¡€å’Œç³»ç»Ÿæ€§å†…å®¹ï¼Œ60-100å­—
- **çŸ¥è¯†å›¾è°±æŸ¥è¯¢**: é’ˆå¯¹ç”¨æˆ·é—®é¢˜ç›¸å…³æ¦‚å¿µçš„å…³è”å…³ç³»å’Œæ·±å±‚è”ç³»ï¼Œ60-100å­—

**é‡è¦åŸåˆ™:**
- æ¯ä¸ªæŸ¥è¯¢éƒ½è¦ç›´æ¥æœåŠ¡äºå›ç­”ç”¨æˆ·é—®é¢˜
- åŸºäºä¸“å®¶åˆ†ææå–çš„æ ¸å¿ƒè¦ç´ æ„å»ºæŸ¥è¯¢
- ç»“åˆå†å²å¯¹è¯çš„ç›¸å…³ä¿¡æ¯
- é¿å…è¿‡åº¦æ‰©å±•å’Œæ— å…³å†…å®¹

ä»¥JSONæ ¼å¼è¿”å›ï¼š
{{
    "tasks": [
        {{"type": "online_search", "query": "é’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„é™ˆè¿°æ€§åœ¨çº¿æœç´¢æŸ¥è¯¢"}},
        {{"type": "knowledge_search", "query": "é’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„é™ˆè¿°æ€§çŸ¥è¯†åº“æŸ¥è¯¢"}}, 
        {{"type": "lightrag_search", "query": "é’ˆå¯¹ç”¨æˆ·é—®é¢˜çš„é™ˆè¿°æ€§çŸ¥è¯†å›¾è°±æŸ¥è¯¢"}}
    ]
}}

è¯·ä¸¥æ ¼åŸºäºç”¨æˆ·é—®é¢˜ç”Ÿæˆæ£€ç´¢æŸ¥è¯¢ï¼Œç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ç›´æ¥æœåŠ¡äºå›ç­”ç”¨æˆ·é—®é¢˜ã€‚
"""


def build_comprehensive_synthesis_prompt(user_question: str, expanded_question: str,
                                       optimized_question: str, results_context: str, 
                                       history_context: str) -> str:
    """
    æ„å»ºç»¼åˆæ€§åˆ†æå›ç­”æç¤ºè¯
    èšç„¦äºç›´æ¥å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œé¿å…æ— ç”¨æ‰©å±•
    
    Args:
        user_question: ç”¨æˆ·åŸå§‹é—®é¢˜
        expanded_question: æ‰©å†™åé—®é¢˜
        optimized_question: ä¼˜åŒ–åé—®é¢˜
        results_context: æ£€ç´¢ç»“æœä¸Šä¸‹æ–‡
        history_context: å¯¹è¯å†å²ä¸Šä¸‹æ–‡
        
    Returns:
        ç»¼åˆåˆ†ææç¤ºè¯
    """
    return f"""
ä½œä¸ºä¸“ä¸šåˆ†æå¸ˆï¼Œæ‚¨éœ€è¦åŸºäºæ£€ç´¢ä¿¡æ¯ä¸ºç”¨æˆ·æä¾›å…¨é¢ã€æ·±å…¥ã€è¯¦ç»†çš„ä¸“ä¸šå›ç­”ã€‚

**æ ¸å¿ƒä»»åŠ¡:**
ç”¨æˆ·é—®é¢˜: {user_question}
å®Œæ•´é—®é¢˜: {expanded_question}
ä¼˜åŒ–é—®é¢˜: {optimized_question}

**ä¿¡æ¯æ¥æº:**
æ£€ç´¢ç»“æœ: {results_context}
å†å²å¯¹è¯: {history_context}

**å›ç­”è¦æ±‚:**

**1. æ ¸å¿ƒåŸåˆ™**
- **å…¨é¢å›ç­”**: å……åˆ†ã€å®Œæ•´åœ°å›ç­”ç”¨æˆ·é—®é¢˜çš„å„ä¸ªæ–¹é¢å’Œå±‚æ¬¡
- **åŸºäºæ£€ç´¢**: æ·±åº¦æŒ–æ˜å’Œåˆ©ç”¨æä¾›çš„æ£€ç´¢ç»“æœä¿¡æ¯
- **èšç„¦ç›¸å…³**: å›´ç»•ç”¨æˆ·é—®é¢˜å±•å¼€ï¼Œä½†è¦å……åˆ†å»¶å±•ç›¸å…³å†…å®¹
- **ç»“åˆå†å²**: è€ƒè™‘å†å²å¯¹è¯çš„ä¸Šä¸‹æ–‡å’Œè¿ç»­æ€§

**2. è¯¦ç»†å›ç­”ç»“æ„**
è¯·æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ä¸°å¯Œè¯¦å®çš„å›ç­”ï¼š

### ğŸ¯ **æ ¸å¿ƒé—®é¢˜å›ç­”**
æä¾›å®Œæ•´ã€å‡†ç¡®çš„é—®é¢˜å›ç­”ï¼Œç¡®ä¿æ¶µç›–é—®é¢˜çš„ä¸»è¦æ–¹é¢å’Œå…³é”®è¦ç‚¹

### ğŸ“Š **æ·±å…¥åˆ†æä¸è¯¦è§£**  
åŸºäºæ£€ç´¢ç»“æœè¿›è¡Œå¤šç»´åº¦ã€å¤šå±‚æ¬¡çš„æ·±å…¥åˆ†æï¼š

#### **èƒŒæ™¯ä¸ç°çŠ¶**
- è¯¦ç»†çš„èƒŒæ™¯ä¿¡æ¯ã€å‘å±•å†ç¨‹å’Œæ¼”å˜è¿‡ç¨‹[å¼•ç”¨å…·ä½“æ¥æº]
- å½“å‰çŠ¶å†µã€ä¸»è¦ç‰¹å¾å’Œå‘å±•è¶‹åŠ¿[å¼•ç”¨æ•°æ®æ”¯æ’‘]
- é‡è¦ç»Ÿè®¡æ•°æ®ã€ç ”ç©¶å‘ç°å’Œæƒå¨è§‚ç‚¹[æ ‡æ³¨ä¿¡æ¯æ¥æº]

#### **æ ¸å¿ƒå†…å®¹è¯¦è§£**
æ ¹æ®é—®é¢˜æ€§è´¨å’Œæ£€ç´¢ä¿¡æ¯ï¼Œè¯¦ç»†å±•å¼€ä»¥ä¸‹ç›¸å…³å†…å®¹ï¼š
- æ ¸å¿ƒæ¦‚å¿µã€å…³é”®è¦ç´ çš„æ·±å…¥è§£é‡Šå’Œæœºåˆ¶åˆ†æ[å¼•ç”¨æƒå¨æ¥æº]
- é‡è¦äº‹å®ã€å…·ä½“æ•°æ®å’Œç ”ç©¶å‘ç°çš„è¯¦ç»†é˜è¿°[å¼•ç”¨å…·ä½“æ•°æ®]
- å…¸å‹æ¡ˆä¾‹ã€å®è·µç»éªŒå’Œåº”ç”¨å®ä¾‹çš„æ·±å…¥åˆ†æ[å¼•ç”¨å…·ä½“æ¡ˆä¾‹]
- å¤šè§’åº¦çš„å¯¹æ¯”åˆ†æã€å…³è”æ€§æ¢è®¨å’Œå½±å“å› ç´ åˆ†æ
- åŸºäºæ£€ç´¢ä¿¡æ¯çš„æ·±å±‚åŸç†è§£é‡Šå’Œæœºåˆ¶æ¢è®¨

#### **æ‹“å±•ä¸å…³è”**
åŸºäºç”¨æˆ·é—®é¢˜ç›¸å…³çš„å»¶å±•å†…å®¹ï¼š
- ç›¸å…³æ¦‚å¿µã€è¡ç”Ÿé—®é¢˜å’Œå…³è”é¢†åŸŸçš„æ¢è®¨
- ä¸åŒè§‚ç‚¹ã€ç ”ç©¶è§’åº¦å’Œç†è®ºæ¡†æ¶çš„å¯¹æ¯”
- å®é™…åº”ç”¨ã€å‘å±•å‰æ™¯å’Œæ½œåœ¨å½±å“çš„åˆ†æ

### ğŸ’¡ **æ·±å±‚æ´å¯Ÿä¸æ€»ç»“**
åŸºäºå…¨é¢åˆ†æå¾—å‡ºçš„é‡è¦å‘ç°ã€æ·±å±‚ç†è§£å’Œä¸“ä¸šè§è§£

### ğŸ“š **è¯¦ç»†ä¿¡æ¯æ¥æº**
å®Œæ•´åˆ—å‡ºæ‰€æœ‰å¼•ç”¨çš„æ£€ç´¢ç»“æœæ¥æºï¼š
[1] åœ¨çº¿æœç´¢ - å®Œæ•´æ ‡é¢˜ - URLé“¾æ¥ - å…³é”®å†…å®¹è¯¦ç»†æ‘˜è¦
[2] çŸ¥è¯†åº“æ£€ç´¢ - æ–‡æ¡£å®Œæ•´æ ‡é¢˜ - å…³é”®å†…å®¹è¯¦ç»†æ‘˜è¦  
[3] çŸ¥è¯†å›¾è°± - æ¦‚å¿µå…³ç³»è¯¦è¿° - å…³é”®å‘ç°è¯¦ç»†æ‘˜è¦

**3. è´¨é‡æ ‡å‡†**
- **èšç„¦æ€§**: æ‰€æœ‰å†…å®¹éƒ½æœåŠ¡äºå›ç­”ç”¨æˆ·é—®é¢˜åŠå…¶ç›¸å…³å»¶å±•
- **å‡†ç¡®æ€§**: åŸºäºæ£€ç´¢ç»“æœï¼Œç¡®ä¿ä¿¡æ¯å‡†ç¡®å¯é æœ‰æ®å¯æŸ¥
- **å®Œæ•´æ€§**: å……åˆ†å›ç­”ç”¨æˆ·é—®é¢˜çš„å„ä¸ªæ–¹é¢å’Œæ·±åº¦å±‚æ¬¡
- **ä¸°å¯Œæ€§**: æä¾›è¯¦å®å……åˆ†çš„å†…å®¹ï¼Œæ·±åº¦æŒ–æ˜æ£€ç´¢ä¿¡æ¯çš„ä»·å€¼
- **å»¶å±•æ€§**: é€‚å½“å»¶å±•ç›¸å…³å†…å®¹ï¼Œæä¾›æ›´å…¨é¢çš„ç†è§£è§†è§’
- **å¼•ç”¨æ€§**: æ‰€æœ‰é‡è¦ä¿¡æ¯éƒ½è¦è¯¦ç»†æ ‡æ³¨æ¥æºå’Œä¾æ®

**é‡è¦æé†’:**
è¯·å……åˆ†åˆ©ç”¨æ£€ç´¢ç»“æœï¼Œæä¾›è¯¦å®ä¸°å¯Œçš„ä¸“ä¸šåˆ†æã€‚åœ¨èšç„¦ç”¨æˆ·é—®é¢˜çš„åŸºç¡€ä¸Šï¼Œå……åˆ†æŒ–æ˜ç›¸å…³ä¿¡æ¯çš„æ·±åº¦å’Œå¹¿åº¦ï¼Œç¡®ä¿å›ç­”å†…å®¹å……å®ã€æœ‰ä»·å€¼ã€‚
"""


def build_knowledge_base_selection_prompt(query: str, knowledge_bases: list) -> str:
    """
    æ„å»ºçŸ¥è¯†åº“æ™ºèƒ½é€‰æ‹©æç¤ºè¯
    
    Args:
        query: ç”¨æˆ·æŸ¥è¯¢
        knowledge_bases: å¯ç”¨çŸ¥è¯†åº“åˆ—è¡¨
        
    Returns:
        çŸ¥è¯†åº“é€‰æ‹©æç¤ºè¯
    """
    # æ„å»ºçŸ¥è¯†åº“æè¿°
    kb_list = []
    for kb in knowledge_bases:
        kb_name = kb.get('name', 'æœªçŸ¥')
        kb_desc = kb.get('description', 'æ— æè¿°')
        kb_list.append(f'"{kb_name}": {kb_desc}')
    
    kb_descriptions = "\n".join(kb_list)
    valid_names = [kb.get('name', '') for kb in knowledge_bases]
    valid_names_str = ', '.join([f'"{name}"' for name in valid_names])
    
    return f"""
æ ¹æ®ç”¨æˆ·çš„æŸ¥è¯¢é—®é¢˜ï¼Œä»ä»¥ä¸‹å¯ç”¨çŸ¥è¯†åº“ä¸­é€‰æ‹©æœ€åˆé€‚çš„ä¸€ä¸ªè¿›è¡Œæ£€ç´¢ã€‚

ç”¨æˆ·æŸ¥è¯¢ï¼š{query}

å¯ç”¨çš„çŸ¥è¯†åº“ï¼š
{kb_descriptions}

**ä¸¥æ ¼çº¦æŸï¼š**
1. ä½ å¿…é¡»ä¸”åªèƒ½ä»ä»¥ä¸‹çŸ¥è¯†åº“åç§°ä¸­é€‰æ‹©ä¸€ä¸ªï¼š{valid_names_str}
2. ä¸å…è®¸ä½¿ç”¨ä»»ä½•å…¶ä»–åç§°ï¼ŒåŒ…æ‹¬ "default"ã€"default_kb"ã€"é»˜è®¤"ç­‰
3. å¦‚æœä¸ç¡®å®šï¼Œè¯·é€‰æ‹© "{valid_names[0] if valid_names else 'test'}"

è¯·åˆ†æç”¨æˆ·æŸ¥è¯¢çš„å†…å®¹å’Œæ„å›¾ï¼Œç„¶åé€‰æ‹©æœ€ç›¸å…³çš„çŸ¥è¯†åº“ã€‚

è¿”å›JSONæ ¼å¼ï¼š
{{
    "collection_name": "å¿…é¡»æ˜¯ä¸Šè¿°åˆ—è¡¨ä¸­çš„å‡†ç¡®åç§°",
    "reason": "é€‰æ‹©è¿™ä¸ªçŸ¥è¯†åº“çš„åŸå› ï¼ˆç®€çŸ­è¯´æ˜ï¼‰"
}}

**å†æ¬¡å¼ºè°ƒï¼šcollection_name å¿…é¡»ä¸¥æ ¼åŒ¹é…ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š{valid_names_str}**
**ç¦æ­¢ä½¿ç”¨ä»»ä½•ä¸åœ¨æ­¤åˆ—è¡¨ä¸­çš„åç§°ï¼**
"""


# æç¤ºè¯é…ç½®å¸¸é‡
class PromptConfig:
    """æç¤ºè¯é…ç½®å¸¸é‡"""
    
    # æ¸©åº¦å‚æ•°
    EXPANSION_TEMPERATURE = 0.4
    ANALYSIS_TEMPERATURE = 0.3
    PLANNING_TEMPERATURE = 0.2
    SYNTHESIS_TEMPERATURE = 0.7
    SELECTION_TEMPERATURE = 0.1
    
    # Tokené™åˆ¶
    MAX_EXPANSION_TOKENS = 800
    MAX_ANALYSIS_TOKENS = 1000
    MAX_PLANNING_TOKENS = 800
    MAX_SYNTHESIS_TOKENS = 4000
    
    # è´¨é‡æ ‡å‡†
    MIN_EXPANSION_LENGTH = 20
    MIN_ANALYSIS_LENGTH = 300
    MIN_SYNTHESIS_LENGTH = 2000
    QUERY_LENGTH_RANGE = (40, 60)
    
    # ç³»ç»Ÿæ¶ˆæ¯
    JSON_SYSTEM_MESSAGE = "You are a helpful assistant that always responds with valid JSON. Never include any text before or after the JSON object." 